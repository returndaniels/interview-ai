# Configuração Apache (httpd) - Backend e Frontend na mesma máquina
# Salve como: /etc/httpd/conf.d/interview-ai.conf

<VirtualHost *:80>
    # IP público do servidor AWS
    ServerName 52.52.87.55
    
    # Frontend servido de /var/www/html
    DocumentRoot /var/www/html
    
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Habilita rewrite para SPA (Vue Router)
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        # Não reescrever URLs de API ou WS
        RewriteCond %{REQUEST_URI} !^/api
        RewriteCond %{REQUEST_URI} !^/ws
        RewriteRule . /index.html [L]
    </Directory>
    
    # ===== PROXY PARA API (Backend na mesma máquina) =====
    # Backend rodando em localhost:8000 (Docker)
    
    ProxyPreserveHost On
    ProxyRequests Off
    
    # API HTTP
    ProxyPass /api http://127.0.0.1:8000
    ProxyPassReverse /api http://127.0.0.1:8000
    
    # WebSocket (Chat)
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/ws/(.*) ws://127.0.0.1:8000/ws/$1 [P,L]
    
    # Fallback para WS se rewrite não funcionar
    ProxyPass /ws ws://127.0.0.1:8000/ws
    ProxyPassReverse /ws ws://127.0.0.1:8000/ws
    
    # Logs
    ErrorLog /var/log/httpd/interview-ai-error.log
    CustomLog /var/log/httpd/interview-ai-access.log combined
    
    # Compressão de arquivos estáticos
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # Cache para assets estáticos
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/x-font-woff "access plus 1 year"
    </IfModule>
    
    # Headers de segurança
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
    </IfModule>
</VirtualHost>
